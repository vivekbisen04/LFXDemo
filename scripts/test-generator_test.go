package main

import (
	"context"
	"os"
	"path/filepath"
	"testing"

	"github.com/google/generative-ai-go/genai"
	"google.golang.org/api/option"
)

// Mock genai.Client for testing purposes
type mockClient struct {
	GenerateContentFunc func(ctx context.Context, req genai.GenerateContentRequest) (*genai.GenerateContentResponse, error)
}

func (m *mockClient) GenerativeModel(modelName string) *genai.GenerativeModel {
	return &genai.GenerativeModel{
		GenerateContent: m.GenerateContentFunc,
	}
}

// Mock FunctionInfo for testing
type mockFunctionInfo struct {
	Name    string
	Content string
}

func TestNewTestGenerator(t *testing.T) {
	// Test case with valid API key
	apiKey := "test-api-key"
	tg := NewTestGenerator(apiKey)
	if tg == nil {
		t.Error("NewTestGenerator returned nil")
	}
	if tg.client == nil {
		t.Error("NewTestGenerator client is nil")
	}

	// Test case with invalid API key (simulated) -  requires mocking genai.NewClient for proper testing.
	// This test would need a more sophisticated mock to simulate an error from genai.NewClient.
}


func TestGenerateTests(t *testing.T) {
	// Test case with valid file path and functions, successful generation
	ctx := context.Background()
	filePath := "testfile.go" // Replace with a valid test file path if needed.  This test will likely fail without a real file.
	functions := []FunctionInfo{mockFunctionInfo{Name: "TestFunc", Content: "func TestFunc() {}"}}
	mockClient := &mockClient{
		GenerateContentFunc: func(ctx context.Context, req genai.GenerateContentRequest) (*genai.GenerateContentResponse, error) {
			return &genai.GenerateContentResponse{
				Candidates: []genai.Candidate{
					{
						Content: genai.Content{
							Parts: []genai.Part{genai.Text("package main\nimport \"testing\"\nfunc TestExample() {}")},
						},
					},
				},
			}, nil
		},
	}
	tg := &TestGenerator{client: mockClient}
	_, err := tg.GenerateTests(ctx, filePath, functions)
	if err != nil {
		t.Errorf("GenerateTests failed: %v", err)
	}

	// Test case with invalid file path (file not found)
	_, err = tg.GenerateTests(ctx, "invalid_file_path.go", functions)
	if err == nil {
		t.Error("GenerateTests did not return an error for invalid file path")
	}

	// Test case with error during code generation (simulated)
	mockClientError := &mockClient{
		GenerateContentFunc: func(ctx context.Context, req genai.GenerateContentRequest) (*genai.GenerateContentResponse, error) {
			return nil, fmt.Errorf("simulated generation error")
		},
	}
	tgError := &TestGenerator{client: mockClientError}
	_, err = tgError.GenerateTests(ctx, filePath, functions)
	if err == nil {
		t.Error("GenerateTests did not return an error for simulated generation error")
	}

	// Test case with no candidates generated
	mockClientNoCandidates := &mockClient{
		GenerateContentFunc: func(ctx context.Context, req genai.GenerateContentRequest) (*genai.GenerateContentResponse, error) {
			return &genai.GenerateContentResponse{}, nil
		},
	}
	tgNoCandidates := &TestGenerator{client: mockClientNoCandidates}
	_, err = tgNoCandidates.GenerateTests(ctx, filePath, functions)
	if err == nil {
		t.Error("GenerateTests did not return an error for no candidates generated")
	}

	// Test case with compilation error (requires mocking validateGeneratedCode)
}


func TestBuildPrompt(t *testing.T) {
	tg := &TestGenerator{}
	filePath := "testfile.go"
	originalContent := "package main\nfunc main() {}"
	functions := []FunctionInfo{mockFunctionInfo{Name: "TestFunc", Content: "func TestFunc() {}"}}
	packageName := "main"
	prompt := tg.buildPrompt(filePath, originalContent, functions, packageName)
	if prompt == "" {
		t.Error("buildPrompt returned empty string")
	}
}

func TestExtractPackageInfo(t *testing.T) {
	tg := &TestGenerator{}
	content := `package mypackage

import (
	"fmt"
	"os"
)

import "path/filepath"`
	packageName, imports := tg.extractPackageInfo(content)
	if packageName != "mypackage" {
		t.Errorf("Unexpected package name: %s", packageName)
	}
	if len(imports) != 3 {
		t.Errorf("Unexpected number of imports: %d", len(imports))
	}
}

func TestCleanupGeneratedCode(t *testing.T) {
	tg := &TestGenerator{}
	generatedCode := "\npackage main\nfunc TestExample() {}\n"
	packageName := "main"
	imports := []string{`"fmt"`}
	cleanedCode := tg.cleanupGeneratedCode(generatedCode, packageName, imports)
	if !strings.Contains(cleanedCode, "package main") {
		t.Error("CleanupGeneratedCode failed to add package declaration")
	}
	if !strings.Contains(cleanedCode, "import \"testing\"") {
		t.Error("CleanupGeneratedCode failed to add testing import")
	}
}

func TestValidateGeneratedCode(t *testing.T) {
	tg := &TestGenerator{}
	// This test requires creating a temporary file and attempting compilation, which is complex to mock effectively.  
	//  A simplified test focusing on error handling from os.WriteFile would be more practical here.
	err := tg.validateGeneratedCode("testfile.go", "package main") // Replace with a valid test file path if needed.
	if err != nil {
		t.Errorf("validateGeneratedCode failed: %v", err)
	}
}

func TestResolveFilePath(t *testing.T) {
	tg := &TestGenerator{}
	// Test case 1: Running from scripts directory
	originalDir, _ := os.Getwd()
	defer os.Chdir(originalDir) // Restore original directory
	os.Chdir("./scripts") // Simulate running from scripts directory
	resolvedPath := tg.resolveFilePath("testfile.go")
	if !strings.HasPrefix(resolvedPath, "../testfile.go") {
		t.Errorf("Unexpected resolved path: %s", resolvedPath)
	}

	// Test case 2: Not running from scripts directory
	os.Chdir("..") // Simulate running from parent directory
	resolvedPath = tg.resolveFilePath("testfile.go")
	if resolvedPath != "testfile.go" {
		t.Errorf("Unexpected resolved path: %s", resolvedPath)
	}
}